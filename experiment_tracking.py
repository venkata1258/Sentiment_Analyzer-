# -*- coding: utf-8 -*-
"""Experiment Tracking

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1cEkWZ3wbfxsmkx6NwOrIRjCoaOlITa0i
"""

!pip install mlflow prefect nltk scikit-learn

import pandas as pd
import re
import pickle
import mlflow
import mlflow.sklearn

from sklearn.model_selection import train_test_split
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.linear_model import LogisticRegression
from sklearn.metrics import f1_score

import nltk
from nltk.corpus import stopwords
from nltk.stem import WordNetLemmatizer

nltk.download('stopwords')
nltk.download('wordnet')

df = pd.read_csv("data.csv")
df = df[['Review text', 'Ratings']]
df = df[df['Ratings'] != 3]
df['sentiment'] = df['Ratings'].apply(lambda x: 1 if x >= 4 else 0)
df.head()

stop_words = set(stopwords.words('english'))
lemmatizer = WordNetLemmatizer()

def clean_text(text):
    text = str(text).lower()
    text = re.sub(r'[^a-z\s]', '', text)
    tokens = text.split()
    tokens = [lemmatizer.lemmatize(w) for w in tokens if w not in stop_words]
    return " ".join(tokens)

df['clean_review'] = df['Review text'].apply(clean_text)

mlflow.set_experiment("Flipkart_Sentiment_Analysis")

mlflow.end_run()
with mlflow.start_run(run_name="TFIDF_Logistic_Run_1"):

    # Parameters
    max_features = 5000
    ngram_range = (1, 2)
    C_value = 1.0

    mlflow.log_param("max_features", max_features)
    mlflow.log_param("ngram_range", ngram_range)
    mlflow.log_param("C", C_value)

    # Features
    X = df['clean_review']
    y = df['sentiment']

    tfidf = TfidfVectorizer(
        max_features=max_features,
        ngram_range=ngram_range
    )
    X_tfidf = tfidf.fit_transform(X)

    X_train, X_test, y_train, y_test = train_test_split(
        X_tfidf, y, test_size=0.25, random_state=42, stratify=y
    )

    # Model
    model = LogisticRegression(max_iter=1000, C=C_value)
    model.fit(X_train, y_train)

    # Metric
    y_pred = model.predict(X_test)
    f1 = f1_score(y_test, y_pred)

    mlflow.log_metric("f1_score", f1)

    # Artifacts
    pickle.dump(model, open("sentiment_model.pkl", "wb"))
    pickle.dump(tfidf, open("tfidf_vectorizer.pkl", "wb"))

    mlflow.log_artifact("sentiment_model.pkl")
    mlflow.log_artifact("tfidf_vectorizer.pkl")

    # Model Registry
    mlflow.sklearn.log_model(
        model,
        "sentiment_model",
        registered_model_name="FlipkartSentimentModel"
    )

for c in [0.1, 1, 10]:
    with mlflow.start_run(run_name=f"LR_C_{c}"):

        mlflow.log_param("C", c)

        model = LogisticRegression(max_iter=1000, C=c)
        model.fit(X_train, y_train)

        y_pred = model.predict(X_test)
        f1 = f1_score(y_test, y_pred)

        mlflow.log_metric("f1_score", f1)

!mlflow ui

